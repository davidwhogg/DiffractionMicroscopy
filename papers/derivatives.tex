%% This file is part of the DiffractionMicroscopy project
%% Copyright 2016 David W. Hogg

% To-Do list
% ----------
% - Generalize to photons on the Ewald sphere.
% - Write zeroth draft.
% - Deal with all HOGG notes.

% Style notes
% -----------
% - Always eqnarray never equation.

\documentclass[12pt]{article}
\usepackage{amsmath, amssymb, mathrsfs, hyperref, graphicx}
\input{vc}

% useless formatting
\linespread{1.08333} % 10/13 spacing
\setlength{\parindent}{1.08333\baselineskip}
\setlength{\parskip}{0ex}
\newcommand{\hoggcaption}[1]{\caption{\textsf{#1}}}
\renewcommand{\thefigure}{\textsf{\arabic{figure}}}
\renewcommand{\figurename}{\textsf{Figure}}
\newcommand{\equationname}{equation}

% math definitions
\newcommand{\setof}[1]{\left\{{#1}\right\}}
\newcommand{\given}{\,|\,}
\newcommand{\dd}{\mathrm{d}}

\begin{document}\sloppy\sloppypar

\section*{\raggedright%
  Derivatives of the likelihood function (with respect to parameters)
  for diffraction microscopy with noisy images at unknown orientations.}
\noindent
David W. Hogg

\noindent{\footnotesize%
Simons Center for Data Analysis, Simons Foundation\\
\texttt{david.hogg@nyu.edu}\\
repository: \texttt{\giturl}\\
hash: \texttt{\githash~(\gitdate)}}

\bigskip

\paragraph{Abstract:}
I write down a likelihood for diffraction microscopy imaging data,
where each image is of the same molecule, but each image contains a
small number of photons, and each image is of the molecule at an
unknown, random orientation.
In this work, at fixed orientation, the likelihood function is
parameterized by linear parameters (densities in three-dimensional
boxels in real space, or Fourier coefficients, or any other linear
representation), but the likelihood function becomes non-linear in
those parameters when the orientation is marginalized out.
Marginalization is performed by a sum over a (random or uniform)
sampling in orientation space.

\section{Introduction}

In diffraction imaging, the fundamental observable is the squared norm
of a slice of the Fourier transform of the object of interest.
In the noisy regime---but when the orientation of the sample in the
beam is known---the detected photons are independent draws from a
variable-rate Poisson process, with rate set by the squared norm of
the relevant slice of the Fourier transform (probably censored by a
beam stop).
When the orientation of the sample in the beam is unknown, the group
of detected photons can no longer be thought of as being independent
draws from a simple process.
While being conditionally independent given the orientation, they are
dependent when the orientation is thought of as an unobserved latent
variable.
This emerges because the orientation controls the slice, and the slice
controls the rate function for the Poisson process; the various
photons in a single image or exposure are generated by the same slice,
but the plane of the slice is not known.

For the purposes of definiteness, we will think of the real-space
object as being described by a density $\rho(x)$, where $x$ is
a three-vector position in real space (units of length).
This density has a Fourier transform $\hat{\rho}(k)$, where the hat
indicates the Fourier transform, and $k$ is a three-vector wave number
(units of inverse length).

We will make use of various properties of the density $\rho(x)$ and of
its Fourier transform $\hat{\rho}(k)$:
One might be that the density $\rho(x)$ has compact support---is
non-zero in a finite domain---which makes the Fourier transform
$\hat{\rho}(k)$ smooth in some corresponding way.
Another is that the density $\rho(x)$ will be real, which makes
$\hat{\rho}(k)$ symmetric in the sense of
$\hat{\rho}(k)=\hat{\rho}(-k)$.
Another might be that the density $\rho(x)$ is non-negative everywhere
(this will often---but not always---be true).
Non-negativity in real space has non-trivial implications for Fourier
space.

\section{Likelihood function}

For us, a probabilistic \emph{model} is a likelihood function (a
probability for the data given parameters) and a prior pdf over (at
least) any nuisance parameters.
This requires that we obtain a parameterization for (either) the
density $\rho(x)$ (or its Fourier transform or some function of
either).
Because our objective is to obtain a description of the real-space
function $\rho(x)$, we will parameterize this function simply as a
linear mixture of $M$ components
\begin{eqnarray}
       \rho(x)  &=& \sum_{m=1}^M a_m\,     g_m(x)
  \\
  \hat{\rho}(k) &=& \sum_{m=1}^M a_m\,\hat{g}_m(k)
\quad ,
\end{eqnarray}
where the $a_m$ are coefficients, the $g_m(x)$ are real-space basis
functions that linearly sum to make the density, and the
$\hat{g}_m(k)$ are the Fourier transforms of those basis functions.

Photons will be observed at transverse wave numbers $k_\perp$, in the
lab in the two-dimensional $k$-space perpendicular to the x-ray beam,
which itself is oriented at angles $\phi$ relative to the molecule.
That is, there is a 2-vector $k_\perp$ that is related to the full
3-vector $k$ by a projection and some rotations, which depend on a set
of three Euler angles, which we denote (as a set) $\phi$.
The three Euler angles can be thought of as a position on the sphere
plus an in-plane rotation.
Or they can be thought of as the three degrees of freedom of
orientation of a two-dimensional lab-frame $k_\perp$ coordinate system
with respect to a three-dimensional molecule-frame $k$ coordinate
system.
The relationship can be written as
\begin{eqnarray}
  k &=& P_\phi \cdot k_\perp
  \quad ,
\end{eqnarray}
where we think of $k$ as a three-element column vector, $P_\phi$ is a
$3\times 2$ deprojection matrix made up of two orthogonal unit
3-vectors (which are fully specified by the Euler angles $\phi$), and
$k_\perp$ is a two-element column vector.

If you set the density function $\rho(x)$ (and thus its Fourier
transform $\hat{\rho}(k)$) and the orientation $\phi$ of the molecule
with respect to the beam, the probability density of getting a photon
at observed lab-frame transverse wave number $k_\perp$ is proportional
to the squared norm of the Fourier transform evaluated at the relevant
$k$.  That is,
\begin{eqnarray}
  p(k_\perp\given\rho,\phi) &\propto& |\hat{\rho}|^2(P_\phi \cdot k_\perp)
  \label{eq:rhosquared} \\
  |\hat{\rho}|^2(k) &\equiv& \hat{\rho}(k)\,\hat{\rho}^{\ast}(k)
  \\
  |\hat{\rho}|^2(k) &=& \sum_{m=1}^M\sum_{m'=1}^M a_m\,a_{m'}\,\hat{g}_m(k)\,\hat{g}_{m'}^{\ast}(k)
  \label{eq:rhosquaredexpansion} \quad ,
\end{eqnarray}
where we have written the squared norm as the complex number times its
complex conjugate, but used the fact that the $a_m$ are real.

The fact that equation~(\ref{eq:rhosquared}) contains nothing more
complicated than a deprojection matrix (no integrals) is a consequence
of the Fourier slice theoem.
Equation~(\ref{eq:rhosquared}) embodies the fundamental fact of
diffraction: The observable is the square of the norm of the Fourier
transform.
This formulation also assumes that there is a ``beam stop'' or
equivalent: The probability density in equation~(\ref{eq:rhosquared})
only describes diffracted photons, not those (the majority)
transmitted without deflection.

HOGG: Need a terminology for the parameters and the data.
\begin{eqnarray}
  y &\equiv& \setof{y_n}_{n=1}^N
  \\
  y_n &\equiv& \setof{k_{\perp nq}}_{q=1}^{Q_n}
  \\
  a &\equiv& \setof{a_m}_{m=1}^M
  \quad,
\end{eqnarray}

HOGG: Marginalization.
\begin{eqnarray}
  \ln p(y\given a) &=& \sum_{n=1}^N \ln p(y_n\given a)
  \\
  p(y_n\given a) &=& \int p(y_n\given a,\phi)\,p(\phi)\,\dd\phi
  \\
  &\approx& \frac{1}{T}\,\sum_{t=1}^T p(y_n\given a,\phi_t)
  \\
  \ln p(y_n\given a) &\approx& \ln\left[\frac{1}{T}\,\sum_{t=1}^T \exp\left[\ln p(y_n\given a,\phi_t)\right]\right]
  \\
  \ln p(y_n\given a,\phi_t) &=& \sum_{q=1}^{Q_n} \ln p(k_{\perp nq}\given a,\phi_t)
  \\
  &=& \sum_{q=1}^{Q_n} \ln |\hat{\rho}|^2(P_{\phi_t}\cdot k_{\perp nq})
  \\
  &=& \sum_{q=1}^{Q_n} \ln\left[ \sum_{m=1}^M\sum_{m'=1}^M a_m\,a_{m'}\,\hat{g}_{ntqm}\,\hat{g}_{ntqm'}^{\ast} \right]
  \\
  \hat{g}_{ntqm} &\equiv& \hat{g}_m(P_{\phi_t}\cdot k_{\perp nq})
  \quad,
\end{eqnarray}
where...HOGG..., and we
have dropped constants in the logarithms.

HOGG: Implementation as logsumexp.

\section{Derivatives}

\begin{eqnarray}
  \frac{\dd}{\dd a_m}\ln p(y\given a) &=& \sum_{n=1}^N \frac{\dd}{\dd a_m}\ln p(y_n\given a)
  \\
  \frac{\dd}{\dd a_m}\ln p(y_n\given a)
    &=& \frac{\displaystyle
      \frac{1}{T}\,\sum_{t=1}^T \exp\left[\ln p(y_n\given a,\phi_t)\right]\,\frac{\dd}{\dd a_m}\ln p(y_n\given a,\phi_t)}%
             {\displaystyle
      \frac{1}{T}\,\sum_{t=1}^T \exp\left[\ln p(y_n\given a,\phi_t)\right]}
  \\
  \frac{\dd}{\dd a_m}\ln p(y_n\given a,\phi_t)
    &=& \sum_{q=1}^{Q_n} \frac{\displaystyle
      \sum_{m'=1}^M a_{m'}\,\hat{g}_{ntqm}\,\hat{g}_{ntqm'}^{\ast}}%
             {\displaystyle
      \sum_{m''=1}^M\sum_{m'=1}^M a_{m''}\,a_{m'}\,\hat{g}_{ntqm''}\,\hat{g}_{ntqm'}^{\ast}}
  \quad,
\end{eqnarray}
where...HOGG

\section{Tangent space}

A (probably faulty) counting argument suggests that the
observable---the squared norm $|\hat{\rho}(x)\,\hat{\rho}^{\ast}(x)|$
of the Fourier transform of the density---has fewer degrees of freedom
than the real-space density $\rho(x)$.
If this is true, at any location in parameter space HOGG there might
be directions HOGG in parameter space in which we can move
(infinitesimally) and not change the observable (to linear order).
These vectors (or the subspace they span) might be useful for
optimization or parameter-space search.

\end{document}
